<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RAG Agent Demo (/agent/ask)</title>
  <style>
    :root{--bg:#0b1220;--panel:#121a2b;--muted:#9fb0c7;--text:#e7eefc;--accent:#6ea8fe;--accent2:#7df0c9;--danger:#ff6b6b}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0b1220 40%,#0c1526);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:18px 20px;border-bottom:1px solid #1b2740;background:rgba(10,16,28,.6);backdrop-filter:blur(6px);position:sticky;top:0;z-index:5}
    header h1{margin:0;font-size:18px;letter-spacing:.4px}
    main{max-width:980px;margin:24px auto 80px;padding:0 20px}
    .card{background:var(--panel);border:1px solid #1b2740;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted)}
    input[type=text], textarea, select{width:100%;background:#0f1627;color:var(--text);border:1px solid #21304d;border-radius:10px;padding:10px 12px;font-size:14px}
    textarea{min-height:120px;resize:vertical}
    .controls{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{cursor:pointer;background:var(--accent);border:none;color:#05122a;padding:10px 14px;border-radius:10px;font-weight:600}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.secondary{background:#21304d;color:#e7eefc}
    .btn.danger{background:var(--danger);color:#fff}
    .grid{display:grid;gap:16px}
    .section{padding:16px}
    .answer{font-size:15px;line-height:1.6}
    .muted{color:var(--muted)}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#1a2744;color:#9fb0c7;font-size:12px}
    .meter{height:8px;border-radius:999px;background:#1a2744;overflow:hidden}
    .meter>i{display:block;height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));width:0}
    details{background:#0f172a;border:1px solid #1e2a45;border-radius:12px;padding:8px 12px}
    summary{cursor:pointer;color:#c6d4ee}
    code, pre{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px}
    pre{background:#0f1627;border:1px solid #21304d;border-radius:10px;padding:12px;overflow:auto}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;background:#15213a;border:1px solid #233559;font-size:12px;color:#a9b8d9}
    .row.wrap{flex-wrap:wrap}
    .kv{display:grid;grid-template-columns:150px 1fr;gap:6px;font-size:13px}
    a{color:#8bc5ff}
    .footer{margin-top:18px;color:#7f93b7;font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>RAG Agent Demo <span class="badge">/agent/ask</span></h1>
  </header>
  <main>
    <section class="card section grid">
      <div class="row wrap">
        <label>API Base URL</label>
        <input id="apiBase" type="text" value="http://localhost:8000" />
        <button class="btn secondary" onclick="saveBase()">Save</button>
      </div>
      <div class="grid">
        <label>Your question</label>
        <textarea id="question" placeholder="Ask something grounded in your corpus... e.g., What does the policy say about refunds?"></textarea>
        <div class="row">
          <label><input type="checkbox" id="trace" /> Return debug trace</label>
          <button class="btn" id="askBtn" onclick="askAgent()">Ask Agent</button>
          <button class="btn secondary" onclick="clearOutput()">Clear</button>
        </div>
      </div>
    </section>

    <section class="card section grid" id="resultCard" style="display:none">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">Answer</h3>
        <div class="row">
          <span class="pill">Confidence: <b id="confVal">0.00</b></span>
          <span class="pill" id="safetyBadge">Safety: ok</span>
          <button class="btn secondary" onclick="copyAnswer()">Copy Answer</button>
          <button class="btn secondary" onclick="copyJSON()">Copy JSON</button>
        </div>
      </div>
      <div class="meter"><i id="confBar"></i></div>
      <div id="answer" class="answer"></div>

      <div class="grid">
        <h4 style="margin:12px 0 0">Citations</h4>
        <div id="cites"></div>
      </div>

      <details id="traceBlock" style="display:none">
        <summary>Execution trace</summary>
        <pre id="tracePre"></pre>
      </details>
      <div class="footer muted">Tip: run <code>uvicorn app.api:app --reload --port 8000</code> then serve this page with <code>python -m http.server 5173 -d frontend</code>.</div>
    </section>
  </main>

  <script>
    const qEl = document.getElementById('question');
    const baseEl = document.getElementById('apiBase');
    const askBtn = document.getElementById('askBtn');
    const traceEl = document.getElementById('trace');

    const resultCard = document.getElementById('resultCard');
    const answerEl = document.getElementById('answer');
    const citesEl = document.getElementById('cites');
    const confBar = document.getElementById('confBar');
    const confVal = document.getElementById('confVal');
    const safetyBadge = document.getElementById('safetyBadge');
    const traceBlock = document.getElementById('traceBlock');
    const tracePre = document.getElementById('tracePre');

    function loadBase(){ const v = localStorage.getItem('apiBase'); if(v) baseEl.value = v; }
    function saveBase(){ localStorage.setItem('apiBase', baseEl.value.trim()); toast('Saved'); }

    function toast(msg){
      console.log(msg);
    }

    function setBusy(b){ askBtn.disabled = b; askBtn.textContent = b ? 'Thinkingâ€¦' : 'Ask Agent'; }
    function clearOutput(){ resultCard.style.display = 'none'; answerEl.textContent = ''; citesEl.innerHTML = ''; tracePre.textContent = ''; }

    function renderFinal(final){
      resultCard.style.display = 'block';
      const ans = final.answer || '';
      answerEl.textContent = ans;
      const conf = Math.max(0, Math.min(1, Number(final.confidence||0)));
      confVal.textContent = conf.toFixed(2);
      confBar.style.width = (conf*100)+'%';
      const s = final.safety || {blocked:false};
      safetyBadge.textContent = s.blocked ? `Safety: BLOCKED (${s.reason||'policy'})` : 'Safety: ok';
      safetyBadge.style.background = s.blocked ? 'var(--danger)' : '#15213a';
      // Citations
      const cites = Array.isArray(final.citations) ? final.citations : [];
      if(!cites.length){citesEl.innerHTML = '<span class="muted">(none)</span>';}
      else{
        citesEl.innerHTML = '';
        cites.forEach(c => {
          const div = document.createElement('div');
          div.className = 'kv';
          div.innerHTML = `<div class="muted">chunk_id</div><div><code>${c.chunk_id||''}</code></div>
                           <div class="muted">section</div><div>${escapeHtml(c.section||'')}</div>
                           <div class="muted">path</div><div>${escapeHtml(c.path||'')}</div>`;
          citesEl.appendChild(div);
        });
      }
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>\"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

    async function askAgent(){
      clearOutput();
      setBusy(true);
      try{
        const base = baseEl.value.replace(/\/$/,'');
        const body = { question: qEl.value.trim(), trace: traceEl.checked };
        if(!body.question){ setBusy(false); return; }
        const res = await fetch(`${base}/agent/ask`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        if(!res.ok){ throw new Error(`HTTP ${res.status}`); }
        const data = await res.json();
        if(traceEl.checked){
          // data has { final, trace }
          renderFinal(data.final || {});
          traceBlock.style.display = 'block';
          tracePre.textContent = JSON.stringify(data.trace||[], null, 2);
        } else {
          // data is just the final payload
          renderFinal(data);
          traceBlock.style.display = 'none';
        }
      }catch(err){
        resultCard.style.display = 'block';
        answerEl.textContent = 'Error: '+err.message;
        citesEl.innerHTML = '';
      } finally{ setBusy(false); }
    }

    function copyAnswer(){ navigator.clipboard.writeText(answerEl.textContent||''); }
    function copyJSON(){
      const base = baseEl.value.replace(/\/$/,'');
      const body = { question: qEl.value.trim(), trace: traceEl.checked };
      // not re-calling backend; just build a JSON from current DOM when available
      const payload = {
        answer: answerEl.textContent||'',
        confidence: Number(confVal.textContent)||0,
        citations: [],
        safety: { blocked: safetyBadge.textContent.includes('BLOCKED') }
      };
      // harvest displayed citations
      const rows = citesEl.querySelectorAll('.kv');
      rows.forEach(r=>{
        const codes = r.querySelectorAll('code');
        const cid = codes[0]?.textContent||'';
        const section = r.children[3]?.textContent||'';
        const path = r.children[5]?.textContent||'';
        payload.citations.push({chunk_id: cid, section, path});
      });
      navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
    }

    // init
    loadBase();
  </script>
</body>
</html>
