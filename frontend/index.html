<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RAG/Agent Chat</title>
  <style>
    body { margin:0; font-family: sans-serif; background:#0b1220; color:#e6eefb; display:flex; height:100vh; }
    .sidebar { width:260px; background:#10192d; border-right:1px solid #1b2740; padding:10px; overflow-y:auto; }
    .chat-list { list-style:none; padding:0; margin:0; }
    .chat-list li { display:flex; justify-content:space-between; align-items:center;
                    padding:8px 10px; cursor:pointer; border-radius:8px; margin-bottom:4px; }
    .chat-list li.active { background:#132244; }
    .chat-title { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .delete-btn { background:none; border:none; color:#a0b3ce; font-size:14px; cursor:pointer; margin-left:6px; }
    .delete-btn:hover { color:#ff6b6b; }
    .chat { flex:1; display:flex; flex-direction:column; }
    .messages { flex:1; padding:16px; overflow-y:auto; }
    .msg { margin-bottom:12px; }
    .msg.user { text-align:right; }
    .msg.assistant { text-align:left; }
    .msg span { display:inline-block; padding:10px 14px; border-radius:12px; max-width:70%; }
    .msg.user span { background:#6ea8fe; color:#05122a; }
    .msg.assistant span { background:#21304d; color:#e7eefc; }
    .input-bar { display:flex; padding:12px; border-top:1px solid #1b2740; background:#10192d; }
    .input-bar textarea { flex:1; resize:none; border:none; border-radius:10px; padding:10px; font-size:14px; background:#0f1627; color:#e6eefb; }
    .btn { margin-left:8px; background:#6ea8fe; border:none; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:600; color:#05122a; }
    .toggle { margin-left:8px; display:flex; align-items:center; gap:6px; color:#a0b3ce; font-size:13px; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <h3>Sessions</h3>
    <ul id="chatList" class="chat-list"></ul>
    <button onclick="newSession()" class="btn" style="margin-top:10px;width:100%;">+ New Chat</button>
  </aside>
  <section class="chat">
    <div id="messages" class="messages"></div>
    <div class="input-bar">
      <textarea id="input" rows="1" placeholder="Type your question..."></textarea>
      <button class="btn" onclick="send()">Send</button>
      <label class="toggle">
        <input type="checkbox" id="agentToggle"> Use Agent
      </label>
    </div>
  </section>

<script>
const base = localStorage.getItem('apiBase') || "http://localhost:8000";
let sessions = JSON.parse(localStorage.getItem('sessions')||"[]");
let currentSession = sessions.length ? sessions[0].id : createSessionId();
renderChatList();

function createSessionId(){ return "sess_" + Math.random().toString(36).slice(2,10); }

function newSession(){
  const id = createSessionId();
  sessions.unshift({id, messages:[]});
  saveSessions();
  currentSession = id;
  renderChatList();
  renderMessages();
}

function deleteSession(id){
  sessions = sessions.filter(s=>s.id!==id);
  if(currentSession===id){
    currentSession = sessions.length ? sessions[0].id : createSessionId();
    if(!sessions.length) sessions.push({id:currentSession, messages:[]});
  }
  saveSessions();
  renderChatList();
  renderMessages();
}

function saveSessions(){ localStorage.setItem('sessions', JSON.stringify(sessions)); }

function renderChatList(){
  const ul = document.getElementById('chatList');
  ul.innerHTML = '';
  sessions.forEach(s=>{
    const li = document.createElement('li');
    const title = document.createElement('span');
    title.className = "chat-title";
    title.textContent = s.messages[0]?.content?.slice(0,30) || "New Chat";
    title.onclick = ()=>{ currentSession=s.id; renderChatList(); renderMessages(); };

    const del = document.createElement('button');
    del.className="delete-btn";
    del.textContent="âœ•";
    del.onclick=(e)=>{ e.stopPropagation(); deleteSession(s.id); };

    li.className = (s.id===currentSession ? "active":"");
    li.appendChild(title);
    li.appendChild(del);
    ul.appendChild(li);
  });
}

function renderMessages(){
  const session = sessions.find(s=>s.id===currentSession);
  const box = document.getElementById('messages');
  box.innerHTML='';
  if(!session) return;
  session.messages.forEach(m=>{
    const div = document.createElement('div');
    div.className = "msg "+m.role;
    div.innerHTML = `<span>${m.content}</span>`;
    box.appendChild(div);
  });
  box.scrollTop = box.scrollHeight;
}

async function send(){
  const input = document.getElementById('input');
  const text = input.value.trim();
  if(!text) return;
  input.value = '';
  const session = sessions.find(s=>s.id===currentSession);
  session.messages.push({role:'user', content:text});
  renderMessages();
  saveSessions();

  const useAgent = document.getElementById('agentToggle').checked;
  const endpoint = useAgent ? "/agent/ask" : "/ask";
  const body = useAgent ? {question:text, session_id:currentSession} : {question:text, session_id:currentSession, top_k_ctx:8};

  const res = await fetch(base+endpoint, {method:"POST", headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
  const data = await res.json();
  const reply = data.final || data.output || data.answer || JSON.stringify(data);

  session.messages.push({role:'assistant', content:reply});
  renderMessages();
  saveSessions();
}

// init
if(!sessions.length) newSession(); else renderMessages();
</script>
</body>
</html>
